# ============================================================================
# WORKFLOW: Integration Tests
# ============================================================================
#
# PURPOSE:
#   Runs integration tests against a deployed CloudFormation stack.
#   Tests the full backend infrastructure including Lambda functions,
#   API Gateway endpoints, and any other AWS resources.
#
# TRIGGERS:
#   1. Called by infrastructure-deploy (workflow_call):
#      - PRIMARY TRIGGER: Automatically triggered after successful stack deployment
#      - Receives: api_endpoint
#      - Runs integration tests against the deployed stack
#   2. Manual trigger (workflow_dispatch):
#      - Can be run manually with required inputs:
#        * api_endpoint: API Gateway endpoint URL
#
# WORKFLOW FLOW:
#   workflow_call OR workflow_dispatch
#       ↓
#   integration-tests runs
#       ↓
#   [Retrieve stack outputs] → [Run integration test suite]
#       ↓
#   [Generate test report] → [Post results to PR]
#       ↓
#   [Set status check] → [Exit with test results]
#
# CALLS OTHER WORKFLOWS:
#   - None (terminal workflow in pipeline)
#
# OUTPUTS:
#   - Test results (pass/fail)
#   - Test coverage report
#   - Test execution logs
#   - Status check for branch protection
#
# DEPENDENCIES:
#   - Must be called by: infrastructure-deploy.yml (or manually)
#   - Requires: Deployed CloudFormation stack with API endpoint
#
# ============================================================================

name: Integration Tests

on:
  workflow_call:
    inputs:
      api_endpoint:
        required: true
        type: string
        description: 'API Gateway endpoint URL'
      stack_name:
        required: true
        type: string
        description: 'CloudFormation stack name'
      branch_name:
        required: true
        type: string
        description: 'Branch name for context'
  
  workflow_dispatch:
    inputs:
      api_endpoint:
        required: true
        type: string
        description: 'API Gateway endpoint URL'
      stack_name:
        required: true
        type: string
        description: 'CloudFormation stack name'
      branch_name:
        required: true
        type: string
        description: 'Branch name for context'

jobs:
  test:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python for integration tests
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: aws_resources/requirements.txt

      # Step 3: Install Python dependencies
      - name: Install Python dependencies
        working-directory: aws_resources
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Run Integration Tests
      - name: Run Integration Tests
        working-directory: aws_resources
        env:
          API_BASE_URL: ${{ inputs.api_endpoint }}
        run: |
          python -m pytest -v backend/tests/integration/test_api.py --junitxml=test-results/integration-tests.xml

      # Step 5: Publish test results to GitHub
      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Integration Test Results
          path: aws_resources/test-results/integration-tests.xml
          reporter: java-junit
          fail-on-error: false
          list-suites: all
          list-tests: all